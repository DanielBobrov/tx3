{% extends "base.html" %}
{% from "components/ttt_board.html" import render_ttt_board %}
{% block title %}Партия {{ game.id if game else '' }} — {{ site_name|default('Кресты-обручи') }}{% endblock %}

{% block content %}
<section class="game-layout">
  <div class="board-col">
    <div class="player top">
      <div class="user">
        <span class="name">{{ game.players[0] if game and game.players[0] else 'Игрок O' }}</span>
        <span class="name">{{ player }}</span>
{#        <span class="rating muted">{{ game.player_o.rating if game else '' }}</span>#}
      </div>
      <div class="clock" id="clockO">{{ "%.2f"|format((o_time_ms or 300000)/60000) }}'</div>
    </div>

    <div class="board-wrap">
      {{ render_ttt_board('tttBoard') }}
    </div>

    <div class="player bottom">
      <div class="user">
        <span class="name">{{ game.players[1] if game and game.players[1] else 'Игрок X' }}</span>
{#        <span class="rating muted">{{ game.player_x.rating if game else '' }}</span>#}
      </div>
      <div class="clock" id="clockX">{{ "%.2f"|format((x_time_ms or 300000)/60000) }}'</div>
    </div>

{#    <div class="game-controls">#}
{#      <button class="btn" id="btnOfferDraw">Предложить ничью</button>#}
{#      <button class="btn ghost" id="btnResign">Сдаться</button>#}
{#      <button class="btn" id="btnRematch">Реванш</button>#}
{#    </div>#}
  </div>

  <aside class="side-col">
    <div class="panel moves">
      <div class="panel-head">
        <h3>Ходы</h3>
        <div class="muted" id="gameStatus">{{ game.status if game else 'Идёт' }}</div>
      </div>
      <ol class="moves-list" id="movesList"></ol>
    </div>

{#    <div class="panel chat">#}
{#      <div class="panel-head"><h3>Чат</h3></div>#}
{#      <div class="chat-log" id="chatLog"></div>#}
{#      <div class="chat-input">#}
{#        <input type="text" id="chatMsg" placeholder="Сообщение...">#}
{#        <button class="btn small" id="chatSend">Отправить</button>#}
{#      </div>#}
{#    </div>#}
  </aside>
</section>
{% endblock %}

{% block scripts %}
<script>
  window.INIT = {
    gameId: "{{ game.game_id if game else '' }}",
    // Кому ходить от вашего лица на клике: 'X' или 'O'
    myMark: "{{ my_mark|default('X') }}",
    // 81 символ ('.', 'X', 'O'), либо сервер подставит свое
    initialGrid: {{ (game.grid if game and game.grid else "." * 81)|tojson }},
    // Активный мини‑квадрат (0..8) или -1 если можно ходить в любой
    activeMini: {{ game.active_mini if game and game.active_mini else 4 }},
    // Победители мини‑досок (массив из 9 значений 'X'/'O'/null)
    miniWins: {{ (game.mini_wins if game and game.mini_wins else [None,None,None,None,None,None,None,None,None])|tojson }},
    wsUrl: "{{ game.ws_url if game else '' }}",
    me: {{ current_user.id if (current_user and current_user.is_authenticated) else 'null' }}
  };
</script>
<script src="/static/js/ttt_board.js"></script>
<script src="/static/js/ttt_game.js"></script>
{% endblock %}