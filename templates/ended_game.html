{% extends "base.html" %}
{% from "components/board.html" import render_board %}
{% from "components/macros.html" import render_player_username %}
{% block title %}{{ _('ended_game_screen.game_number') }} {{ game.id if game else '' }} — {{ _('common.site_title') }}{% endblock %}

{% block content %}
    <link rel="stylesheet" href="/static/css/game.css">
    <section class="game-layout">
        <div class="board-col">
            <div class="player top">
                <div class="nickname">
                    X:
                    <div id="usernameX">{{ render_player_username(game.players[0], players) }}</div>
                    {#        <span class="rating muted">{{ game.player_o.rating if game else '' }}</span>#}
                </div>
                {% if game.use_time %}
                    <div class="time">
                        <div class="clock" id="clockX">-:-.-</div>
                    </div>
                {% endif %}
            </div>

            <div class="board-wrap">
                {{ render_board('Board') }}
            </div>

            <div class="player bottom">
                <div class="nickname">
                    O:
                    <div id="usernameO">{{ render_player_username(game.players[1], players) }}</div>
                    {#        <span class="rating muted">{{ game.player_x.rating if game else '' }}</span>#}
                </div>
                {% if game.use_time %}
                    <div class="time">
                        <div class="clock" id="clockO">-:-.-</div>
                    </div>
                {% endif %}
            </div>

            {#    <div class="game-controls">#}
            {#      <button class="btn" id="btnOfferDraw">Предложить ничью</button>#}
            {#      <button class="btn ghost" id="btnResign">Сдаться</button>#}
            {#      <button class="btn" id="btnRematch">Реванш</button>#}
            {#    </div>#}
        </div>

        <aside class="side-col">
            <div class="panel moves">
                <div class="panel-head">
                    <h3>{{ _('ended_game_screen.moves') }}</h3>
                    <div class="muted" id="gameStatus">{{ game.status if game else 'Идёт' }}</div>
                </div>
                <div class="moves-list" id="movesList"></div>
                <div class="moves-nav">
                    <div></div>
                    <button class="btn"
                            id="copyPositionBtn"
{#                            onclick="{if (window.INIT.fen) {navigator.clipboard.writeText(window.INIT.fen);}}"#}
                    >{{ _('moves_history.copy_pgn') }}
                    </button>
                    <div></div>
                    <button id="navFirst" title="{{ _('moves_history.to_first_move') }}">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"></path>
                        </svg>
                    </button>
                    <button id="navPrev" title="{{ _('moves_history.to_previous_move') }}">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg>
                    </button>
                    <button id="navNext" title="{{ _('moves_history.to_next_move') }}">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
                        </svg>
                    </button>
                    <button id="navLast" title="{{ _('moves_history.to_last_move') }}">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"></path>
                        </svg>
                    </button>
                    <div></div>
                    <button class="btn" onclick="window.location.href = '/analysis?game_id={{ game.id if game else 0 }}'">{{ _('ended_game_screen.analyze_position') }}</button>
                </div>
                <div class="viewing-indicator" id="viewingIndicator">
                    {{ _('ended_game_screen.viewing_move') }} <span id="viewingMoveNum"></span>
                </div>
            </div>
        </aside>
    </section>
{% endblock %}

{% block scripts %}
    <script>
        None = null;
        window.INIT = {
            gameId: "{{ game.id if game else '' }}",
            // 81 символ ('.', 'X', 'O'), либо сервер подставит свое
            initialGrid: {{ game.grid | safe }},
            // Активный мини‑квадрат (0..8) или -1 если можно ходить в любой
            activeMini: {{ -1 }},
            {#me: {{ player if player else 'null' }}#}
            shit: "{{ game }}",
        };
    </script>
    <script src="/static/js/socket.io.js"></script>
    <script src="/static/js/board.js"></script>
    <script src="/static/js/timer.js"></script>
    <script src="/static/js/moves_history.js"></script>
    {#    <script src="/static/js/game.js"></script>#}
    <script>
        const board = new Board('#Board', {
            activeMini: -1,
        });
        window.board = board;
        board.setState({{ game.grid | safe }}, "{{ game.pgn }}");
        board.setActiveMini(-1);
        movesHistoryManager = new MovesHistoryManager(board, null);
        movesHistoryManager.setMoves("{{ game.pgn }}");


        {% if game.use_time %}
            document.getElementById("clockX").textContent = formatTime({{ game.left_time[0]*1000 }});
            document.getElementById("clockO").textContent = formatTime({{ game.left_time[1]*1000 }});
        {% endif %}

        function swapPlayers() {
            let player1 = document.querySelector(".player.top");
            let player2 = document.querySelector(".player.bottom");

            let h1 = player1.innerHTML;
            let h2 = player2.innerHTML;

            player1.innerHTML = h2;
            player2.innerHTML = h1;
        }
    </script>
{% endblock %}