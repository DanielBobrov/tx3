{% extends "base.html" %}
{% from "components/board.html" import render_board %}
{% from "components/macros.html" import render_player_username %}
{% block title %}Партия {{ game.id if game else '' }} — {{ site_name|default('Кресты-обручи') }}{% endblock %}

{% block content %}
    <link rel="stylesheet" href="/static/css/game.css">
    <link rel="stylesheet" href="/static/css/analysis.css">
    <section class="game-layout">
        <div class="board-col">
            <div class="player top">
                <div class="nickname">
                    X: {{ render_player_username(game.players[0] if game else None, players) if game else 'Игрок 1' }}
                </div>
                {% if game and game.use_time %}
                    <div class="time">
                        {% if game.players[1] == player.id %}
                            <div class="btn" id="addTimeBtn">+</div>
                        {% endif %}
                        <div class="clock" id="clockX">-:-.-</div>
                    </div>
                {% endif %}
            </div>

            <div class="board-wrap">
                {{ render_board('Board') }}
            </div>

            <div class="player bottom">
                <div class="nickname">
                    O: {{ render_player_username(game.players[1] if game else None, players) if game else 'Игрок 2' }}
                </div>
                {% if game and game.use_time %}
                    <div class="time">
                        {% if game.players[0] == player.id %}
                            <div class="btn" id="addTimeBtn">+</div>
                        {% endif %}
                        <div class="clock" id="clockO">-:-.-</div>
                    </div>
                {% endif %}
            </div>

            {#            <div class="game-controls">#}
            {#                <button class="btn" id="btnOfferDraw">Предложить ничью</button>#}
            {#                <button class="btn ghost" id="btnResign">Сдаться</button>#}
            {#                <button class="btn" id="btnRematch">Реванш</button>#}
            {#            </div>#}
        </div>

        <aside class="side-col">
            <div class="panel moves">
                <div class="panel-head">
                    <h3>{{ _('analysis_screen.title') }}</h3>
                    <div class="muted" id="gameStatus">{{ _('game_state.current_move') }} X</div>
                </div>
                <div id="movesTree"></div>
                <div class="navigation-controls"></div>
                <div class="moves-nav">
                    <div></div>
                    <button class="btn" id="copyPositionBtn" title="{{ _('moves_history.copy_pgn') }}">
                        {{ _('moves_history.copy_pgn') }}
                    </button>
                    <div class="nav-spacer"></div>
                    <button id="navFirst" title="{{ _('moves_history.to_first_move') }}">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"></path>
                        </svg>
                    </button>
                    <button id="navPrev" title="{{ _('moves_history.to_previous_move') }}">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg>
                    </button>
                    <button id="navNext" title="{{ _('moves_history.to_next_move') }}">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
                        </svg>
                    </button>
                    <button id="navLast" title="{{ _('moves_history.to_last_move') }}">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"></path>
                        </svg>
                    </button>
                    <div></div>
                    <button class="btn" id="pastePgnBtn" title="{{ _('moves_history.paste_pgn') }}">
                        {{ _('moves_history.paste_pgn') }}
                    </button>
                    <div></div>
                </div>
            </div>
        </aside>
    </section>
{% endblock %}

{% block scripts %}
    <script src="/static/js/board.js"></script>
    <script type="module" src="/static/js/analysis.js"></script>
    <script>
        None = null;
        
        // Получаем game_id из URL
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('game_id');
        
        let initialPgn = '';
        let initialFen = '';
        
        {% if game %}
            initialPgn = "{{ game.pgn if game.pgn else '' }}";
            initialFen = "{{ game.fen if game.fen else '04' + '0'*81 }}";
        {% endif %}
        
        window.INIT = {
            gameId: gameId,
            myMark: "X",
            fen: initialFen,
            initialPgn: initialPgn,
            activeMini: 4,
        };
        
        // Инициализация после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Создаем доску
            const board = new Board('#Board', {
                myMark: 'X',
                activeMini: -2, // Блокируем все в режиме анализа
                onMove: async (moveData) => {
                    // Обработка кликов через AnalysisManager
                    if (window.analysisManager) {
                        // Вычисляем индекс клетки внутри мини-доски (0-8)
                        // row и col - глобальные координаты (0-8)
                        const cellIndex = 3 * (moveData.row % 3) + (moveData.col % 3);
                        return window.analysisManager.addMove(cellIndex);
                    }
                    return false;
                }
            });
            
            // Создаем менеджер анализа
            window.analysisManager = new AnalysisManager(board, window.INIT.fen);
            
            // Загружаем партию если есть
            if (window.INIT.initialPgn && window.INIT.initialPgn.length > 0) {
                window.analysisManager.buildTreeFromPgn(window.INIT.initialPgn, null);
            }
        });
    </script>
{% endblock %}